<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QRコードをスキャン</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", Arial, "Helvetica Neue", sans-serif;
      margin: 16px;
    }
    .wrap { max-width: 680px; margin: 0 auto; }
    video { width: 100%; border-radius: 12px; background: #000; }
    .btns { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .out { margin-top: 12px; padding: 12px; border-radius: 10px; background: #f6f7f9; word-break: break-all; }
    .hint { color: #666; font-size: 14px; }
    input[type=file] { display: none; }
    label[for=upload] {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>QRコードをスキャン</h1>
  <div class="hint">ヒント：HTTPSまたはlocalhostで開いてください。iOSはSafari、AndroidはChromeを推奨します。</div>

  <div class="btns">
    <button id="startBtn">カメラを起動してスキャン</button>
    <button id="stopBtn" disabled>カメラを停止</button>
    <label for="upload">または画像から読み取る</label>
    <input id="upload" type="file" accept="image/*" capture="environment">
  </div>

  <video id="preview" muted playsinline></video>
  <div class="out" id="result">結果はここに表示されます</div>
</div>

<!-- スキャン機能 -->
<script type="module">
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";
import { NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm";

const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const upload   = document.getElementById('upload');
const videoEl  = document.getElementById('preview');
const resultEl = document.getElementById('result');

let controls = null;
let reader   = null;

function show(text) {
  resultEl.textContent = text;
}

function linkify(text) {
  try {
    const url = new URL(text);
    return `<a href="${url.href}" target="_blank" rel="noopener noreferrer">${url.href}</a>`;
  } catch {
    return text;
  }
}

async function startScan() {
  if (controls) return;
  reader = reader || new BrowserMultiFormatReader();

  const videoConstraints = {
    audio: false,
    video: { facingMode: { ideal: "environment" } }
  };

  startBtn.disabled = true;
  show("カメラを起動しています… カメラの使用を許可してください。");

  try {
    controls = await reader.decodeFromVideoDevice(
      null,
      videoEl,
      (result, err, c) => {
        if (result) {
          const text = result.getText();
          const html = linkify(text);
          resultEl.innerHTML = "✔ 読み取り成功：<br>" + html;

          // 読み取り後に自動停止
          stopScan();
        } else if (err && !(err instanceof NotFoundException)) {
          console.warn(err);
        }
      }
    );

    stopBtn.disabled = false;
    show("カメラが起動しました。QRコードを枠内に合わせてください。");
  } catch (e) {
    console.error(e);
    show("❌ カメラを起動できませんでした。権限がないか、HTTPS環境ではない可能性があります。\nエラー：" + e);
    startBtn.disabled = false;
  }
}

function stopScan() {
  try { controls?.stop(); } catch {}
  controls = null;
  stopBtn.disabled = true;
  startBtn.disabled = false;
}

startBtn.addEventListener('click', startScan);
stopBtn.addEventListener('click', stopScan);

// 画像アップロード解析
upload.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  show("画像を読み込んでいます…");
  const url = URL.createObjectURL(file);

  try {
    reader = reader || new BrowserMultiFormatReader();
    const res = await reader.decodeFromImageUrl(url);
    const text = res.getText();
    const html = linkify(text);
    resultEl.innerHTML = "✔ 読み取り成功：<br>" + html;
  } catch (err) {
    console.error(err);
    show("❌ QRコードの認識に失敗しました。もう少し鮮明な画像をお試しください。");
  } finally {
    URL.revokeObjectURL(url);
  }
});

// ページ離脱時にカメラを停止
window.addEventListener('pagehide', stopScan);
window.addEventListener('beforeunload', stopScan);
</script>

<!-- オプション：BarcodeDetectorのサポート検出 -->
<script>
if ('BarcodeDetector' in window) {
  console.log('このデバイスは BarcodeDetector に対応しています。ネイティブAPIで高速スキャン可能です。');
}
</script>
</body>
</html>
